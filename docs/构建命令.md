# 1Panel Docker Compose 编排

将以下内容直接复制到 1Panel 的 Docker Compose 编排中即可使用。

## 编排配置

```yaml
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: contract-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - JWT_SECRET=your-super-secret-jwt-key-change-me-in-production
      - JWT_EXPIRES_IN=7d
      - DATABASE_URL=file:/app/db/contract.db
      - UPLOAD_DIR=/app/uploads
      # 可选：限制 CORS 来源，多个用逗号分隔
      # - CORS_ORIGINS=http://example.com,http://192.168.1.100:3000
    volumes:
      - ./data/db:/app/db
      - ./data/uploads:/app/uploads
    networks:
      - contract-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: contract-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - contract-network

networks:
  contract-network:
    driver: bridge
```

## 使用说明

### 1. 前置准备

确保代码目录结构如下：
```
/your/project/path/
├── backend/
│   ├── Dockerfile
│   └── ...
├── frontend/
│   ├── Dockerfile
│   └── ...
├── data/           # 会自动创建
│   ├── db/         # SQLite 数据库持久化目录
│   └── uploads/    # 上传文件持久化目录
└── docker-compose.yml
```

### 2. 修改配置

> ⚠️ **重要**: 请务必修改 `JWT_SECRET` 为强随机字符串！

可以使用以下命令生成：
```bash
openssl rand -base64 32
```

### 3. 部署方式

**方式一：1Panel 编排**
1. 在 1Panel 中创建新的 Docker Compose 应用
2. 将上面的 YAML 配置粘贴到编排内容中
3. 设置工作目录为项目根目录
4. 点击部署

**方式二：命令行部署**
```bash
# 进入项目目录
cd /your/project/path

# 构建并启动
docker compose up -d --build

# 查看日志
docker compose logs -f

# 停止服务
docker compose down
```

### 4. 访问地址

- **Web 界面**: `http://服务器IP:3000`
- **API 接口**: `http://服务器IP:3000/api`

### 5. 数据持久化

数据存储在 `./data` 目录下：
- `./data/db/contract.db` - SQLite 数据库文件
- `./data/uploads/` - 上传的合同附件

> 💡 备份时只需备份 `./data` 目录即可。

### 6. 端口修改

如需修改对外端口，修改 frontend 服务的 ports 配置：
```yaml
ports:
  - "8080:80"  # 改为 8080
```

### 7. CORS 跨域配置（可选）

如需限制跨域来源，在 backend 服务中添加环境变量：
```yaml
environment:
  - CORS_ORIGINS=http://your-domain.com,http://192.168.1.100:3000
```

不设置则默认允许所有来源（适合局域网使用）。
